(function(){"use strict";angular.module("app-timelines").controller("timelinesController",["$scope","$http","$document","NgMap",function(n,t,i,r){function y(){return[{name:"xs",intervals:h("xs"),timelines:c("xs")},{name:"sm",intervals:h("sm"),timelines:c("sm")},{name:"md",intervals:h("md"),timelines:c("md")},{name:"lg",intervals:h("lg"),timelines:c("lg")},]}function u(n){var t=3;switch(n){case"xs":t=1;break;case"sm":t=2;break;case"md":t=2;break;case"lg":t=3}return t}function h(t){for(var f=[],e=u(t),i=n.currentYear,r=0;r<e;r++)f[r]=i<0?i*-1+" B.C.E":i===0?"1 C.E":i+" C.E",i+=n.config.yearsPerInterval;return f}function c(t){var f=u(t),i=n.currentYear-n.config.yearsPerInterval/2,r=i+f*n.config.yearsPerInterval;return n.timelines.filter(function(n){var t=n.start,u=n.end;return n.unknownStart!==null&&n.unknownStart<n.start&&(t=n.unknownStart),n.unknownEnd!==null&&n.unknownEnd>n.end&&(u=n.unknownEnd),t>=i&&t<r||u>i&&u<=r||t<i&&u>r})}function p(n){var t={start:0,end:0};return t.start=n.start,t.end=n.end,n.unknownStart!==null&&n.unknownStart<=n.start&&(t.start=0),n.unknownEnd!==null&&n.unknownEnd>n.end&&(t.end=0),t}function b(t){return n.timelines.filter(function(n){return n.id===t})}function k(t,i){var f=u(i),r=n.currentYear-n.config.yearsPerInterval/2,e=r+f*n.config.yearsPerInterval;return t.filter(function(n){return n.year>=r&&n.year<=e||n.year===null})}function d(t,i,r){var l=u(r),f=0,s=n.currentYear-n.config.yearsPerInterval/2,h=s+l*n.config.yearsPerInterval,c=g(i),e=t.previousEventYear,o=t.year;return e===null&&(e=c),e<s&&(e=s),o===null&&(o=c),o>h&&(o=h),f=(o-e)*n.pixelsPerYear,(t.previousEventYear!==null||o===e)&&(f-=10),t.previousEventYear!==null&&t.previousEventYear>=s&&(f-=10),t.previousEventYear!==null&&t.previousEventYear===s&&(f-=10),t.year===h&&(f-=10),f}function g(t){var r=n.currentYear-n.config.yearsPerInterval/2,i=t.start;return t.unknownStart!==null&&t.unknownStart<t.start&&(i=t.unknownStart),i<r&&(i=r),i}function w(t,i){var s=u(i),e=0,f=n.currentYear-n.config.yearsPerInterval/2,o=f+s*n.config.yearsPerInterval,r=t.start;return t.unknownStart!==null&&t.unknownStart<t.start&&(r=t.unknownStart),r>o&&(r=o),r>=f&&(e=(r-f)*n.pixelsPerYear),e}function l(t,i){var o=u(i),s=0,f=n.currentYear-n.config.yearsPerInterval/2,h=f+o*n.config.yearsPerInterval,r,e;return t.unknownStart!==null&&t.unknownStart<t.start&&(r=t.unknownStart,e=t.start,r<f&&(r=f),e>f+o*n.config.yearsPerInterval&&(e=f+o*n.config.yearsPerInterval),r>=f&&r<h&&r<e&&(s=(e-r)*n.pixelsPerYear)),s}function o(t,i){var h=u(i),s=0,f=n.currentYear-n.config.yearsPerInterval/2,o=f+h*n.config.yearsPerInterval,r=t.start,e=t.end;return r<f&&(r=f),e>o&&(e=o),r>=f&&r<o&&r<e&&(s=(e-r)*n.pixelsPerYear),s}function a(t,i){var o=u(i),s=0,f=n.currentYear-n.config.yearsPerInterval/2,h=f+o*n.config.yearsPerInterval,r,e;return t.unknownEnd!==null&&t.unknownEnd>t.end&&(r=t.end,e=t.unknownEnd,r<f&&(r=f),e>f+o*n.config.yearsPerInterval&&(e=f+o*n.config.yearsPerInterval),r>=f&&r<h&&r<e&&(s=(e-r)*n.pixelsPerYear)),s}var f,s,e,v;for(n.isBusy=!0,n.timelines=[],n.config={intervalWidth:360,yearsPerInterval:500,startYear:-4030,endYear:2020},n.currentYear=n.config.startYear,n.intervalYears=[1,5,10,50,100,500,1e3],n.years=[],f=0;f<n.config.endYear-n.currentYear+1;f++)s=n.currentYear+f,e=n.currentYear+f,s!==0&&(e=s<0?e+" B.C.E":e+" C.E",v={value:s,name:e},n.years.push(v));n.selectedYear=n.years[0];n.sizes=y();n.pixelsPerYear=n.config.intervalWidth/n.config.yearsPerInterval;n.changeConfig=function(){n.currentYear=n.selectedYear.value;n.sizes=y();n.pixelsPerYear=n.config.intervalWidth/n.config.yearsPerInterval};$(window).on("shown.bs.modal",function(){for(var i,u,f,e,o,t=0;t<n.sizes.length;t++)for(i=n.sizes[t],u=0;u<i.timelines.length;u++)for(f=i.timelines[u],e=0;e<f.events.length;e++)o=f.events[e],o.place&&r.getMap("map-"+i.name+"-"+f.id+"-"+o.id).then(function(n){var t=n.getCenter();google.maps.event.trigger(n,"resize");n.setCenter(t)})});t.get("/api/timelines").then(function(t){angular.copy(t.data,n.timelines);n.changeConfig()},function(){n.errorMessage="Failed to load data"}).finally(function(){n.isBusy=!1});n.parents=[];n.children=[];n.spouse=[];n.siblings=[];n.setHighlights=function(t){n.clearHighlights();var i=b(t);n.parents=[];n.children=[];n.spouse=[];n.siblings=[];i[0].parents&&i[0].parents.length&&n.parents.push.apply(n.parents,i[0].parents);i[0].children&&i[0].children.length&&n.children.push.apply(n.children,i[0].children);i[0].spouse&&i[0].spouse.length&&n.spouse.push.apply(n.spouse,i[0].spouse);i[0].siblings&&i[0].siblings.length&&n.siblings.push.apply(n.siblings,i[0].siblings)};n.clearHighlights=function(){n.parents=[];n.children=[];n.spouse=[]};n.isParent=function(t){return n.parents.indexOf(t)!==-1};n.isChild=function(t){return n.children.indexOf(t)!==-1};n.isSpouse=function(t){return n.spouse.indexOf(t)!==-1};n.isSibling=function(t){return n.siblings.indexOf(t)!==-1};n.isMale=function(n){return n==="Male"};n.isFemale=function(n){return n==="Female"};n.isSpirit=function(n){return n==="Spirit"};n.fastBackward=function(t){var f=u(t),i=n.config.startYear,r=n.years.filter(function(n){return n.value===i});n.selectedYear=r[0];n.changeConfig()};n.backward=function(t){var i=u(t),r=n.currentYear-n.config.yearsPerInterval*i,f=n.years.filter(function(n){return n.value===r});n.selectedYear=f[0];n.changeConfig()};n.forward=function(t){var i=u(t),r=n.currentYear+n.config.yearsPerInterval*i,f=n.years.filter(function(n){return n.value===r});n.selectedYear=f[0];n.changeConfig()};n.fastForward=function(t){var i=u(t),r=n.config.endYear-n.config.yearsPerInterval*(i-1),f=n.years.filter(function(n){return n.value===r});n.selectedYear=f[0];n.changeConfig()};n.getTimelineWidth=function(t){var i=u(t),r=n.config.intervalWidth*i+"px";return{width:r}};n.getTimelineClass=function(n){return"visible-"+n+"-block"};n.getTimelineTitle=function(t){var i=t.name,r,u;return t.meaning&&(i+=" ["+t.meaning+"]"),r=n.getTimelineRangeString(t),r&&(i+="\n"+r),u=n.getRangeInYearsString(t),u&&(i+="\n"+u),i};n.getTimelineRangeString=function(n){var i="",t=p(n);return t.start===0||t.end===0?null:(i+=t.start<0?t.start*-1+" B.C.E":t.start===0?"?":t.start+" C.E",i+=" - ",i+(t.end<0?t.end*-1+" B.C.E":t.end===0?"?":t.end+" C.E"))};n.getRangeInYearsString=function(n){var t=p(n),i;return t.start===0||t.end===0?null:(i=0,i=t.start<0?t.end<0?(t.start-t.end)*-1:t.start*-1+t.end:t.end-t.start,""+("("+i+" yrs)"))};n.getEventYearString=function(n){var t="";return n===null?t="?":t+=n<0?n*-1+" B.C.E":n+" C.E",t};n.getEventTitle=function(t){var i=t.name+" \n";return i+n.getEventYearString(t.year)};n.getIntervalWidth=function(){var t=n.config.intervalWidth+"px";return{width:t}};n.selectTimeline=function(t){t.isSelected=!t.isSelected;n.setHighlights(t.id)};n.getHtmlEventText=function(n){var t=new showdown.Converter;return t.makeHtml(n)};n.getImageSrc=function(n){return n?n:"./images/placeholder.png"};n.$watch("sizes",function(){n.getCurrentEvents=function(n,t){return k(n,t)};n.getTimelineDetailsVoidWidth=function(n,t){var i=w(n,t)-10+"px";return{width:i}};n.getEventVoidWidth=function(n,t,i){var r=d(n,t,i)+"px";return{width:r}};n.getTimelineVoidWidth=function(n,t){var i=w(n,t)+"px";return{width:i}};n.getCompleteWidth=function(n,t){var i=l(n,t),r=o(n,t),u=a(n,t),f=i+r+u;return{width:f}};n.getUnknownStartWidth=function(n,t){var i=l(n,t)+"px";return{width:i}};n.getMainWidth=function(n,t){var i=o(n,t)+"px";return{width:i}};n.getUnknownEndWidth=function(n,t){var i=a(n,t)+"px";return{width:i}};n.getUnknownStartTimelineName=function(n,t){var i=l(n,t),r=o(n,t),u=a(n,t);return r===0&&i>0&&i>u?n.name:""};n.getMainTimelineName=function(n,t){var i=o(n,t);return i>0?n.name:""};n.getUnknownEndTimelineName=function(n,t){var r=l(n,t),u=o(n,t),i=a(n,t);return u===0&&i>0&&i>r?n.name:""}})}])})();