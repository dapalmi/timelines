(function(){"use strict";angular.module("app-timelines").controller("timelinesController",["$scope","$http",function(n,t){function a(){return[{name:"xs",intervals:e("xs"),timelines:o("xs")},{name:"sm",intervals:e("sm"),timelines:o("sm")},{name:"md",intervals:e("md"),timelines:o("md")},{name:"lg",intervals:e("lg"),timelines:o("lg")},]}function i(n){var t=3;switch(n){case"xs":t=1;break;case"sm":t=2;break;case"md":t=2;break;case"lg":t=3}return t}function e(t){for(var f=[],e=i(t),r=n.currentYear,u=0;u<e;u++)f[u]=r<0?r*-1+" B.C.E":r===0?"1 C.E":r+" C.E",r+=n.config.yearsPerInterval;return f}function o(t){var f=i(t),r=n.currentYear-n.config.yearsPerInterval/2,u=r+f*n.config.yearsPerInterval;return n.timelines.filter(function(n){var t=n.start,i=n.end;return n.unknownStart!==null&&n.unknownStart<n.start&&(t=n.unknownStart),n.unknownEnd!==null&&n.unknownEnd>n.end&&(i=n.unknownEnd),t>=r&&t<u||i>r&&i<=u||t<r&&i>u})}function y(n){var t={start:0,end:0};return t.start=n.start,t.end=n.end,n.unknownStart!==null&&n.unknownStart<n.start&&(t.start=0),n.unknownEnd!==null&&n.unknownEnd>n.end&&(t.end=0),t}function p(t){return n.timelines.filter(function(n){return n.id===t})}function w(t,r){var f=i(r),u=n.currentYear-n.config.yearsPerInterval/2,e=u+f*n.config.yearsPerInterval;return t.filter(function(n){return n.year>=u&&n.year<=e})}function b(t,r,u){var c=i(u),f=0,o=n.currentYear-n.config.yearsPerInterval/2,h=o+c*n.config.yearsPerInterval,l=k(r),e=t.previousEventYear,s=t.year;return e===null&&(e=l),e<o&&(e=o),s>h&&(s=h),f=(s-e)*n.pixelsPerYear,(t.previousEventYear!==null||s===e)&&(f-=10),t.previousEventYear!==null&&t.previousEventYear>=o&&(f-=10),t.previousEventYear!==null&&t.previousEventYear===o&&(f-=10),t.year===h&&(f-=10),f}function k(t){var r=n.currentYear-n.config.yearsPerInterval/2,i=t.start;return t.unknownStart!==null&&t.unknownStart<t.start&&(i=t.unknownStart),i<r&&(i=r),i}function v(t,r){var s=i(r),e=0,f=n.currentYear-n.config.yearsPerInterval/2,o=f+s*n.config.yearsPerInterval,u=t.start;return t.unknownStart!==null&&t.unknownStart<t.start&&(u=t.unknownStart),u>o&&(u=o),u>=f&&(e=(u-f)*n.pixelsPerYear),e}function d(t,r){var h=i(r),s=0,e=n.currentYear-n.config.yearsPerInterval/2,o=e+h*n.config.yearsPerInterval,u=t.start,f=t.end;return t.unknownStart!==null&&t.unknownStart<t.start&&(u=t.unknownStart),u<e&&(u=e),t.unknownEnd!==null&&t.unknownEnd>t.end&&(f=t.unknownEnd),f>o&&(f=o),u>=e&&u<o&&u<f&&(s=(f-u)*n.pixelsPerYear),s}function h(t,r){var o=i(r),s=0,f=n.currentYear-n.config.yearsPerInterval/2,h=f+o*n.config.yearsPerInterval,u,e;return t.unknownStart!==null&&t.unknownStart<t.start&&(u=t.unknownStart,e=t.start,u<f&&(u=f),e>f+o*n.config.yearsPerInterval&&(e=f+o*n.config.yearsPerInterval),u>=f&&u<h&&u<e&&(s=(e-u)*n.pixelsPerYear)),s}function s(t,r){var h=i(r),s=0,f=n.currentYear-n.config.yearsPerInterval/2,o=f+h*n.config.yearsPerInterval,u=t.start,e=t.end;return u<f&&(u=f),e>o&&(e=o),u>=f&&u<o&&u<e&&(s=(e-u)*n.pixelsPerYear),s}function c(t,r){var o=i(r),s=0,f=n.currentYear-n.config.yearsPerInterval/2,h=f+o*n.config.yearsPerInterval,u,e;return t.unknownEnd!==null&&t.unknownEnd>t.end&&(u=t.end,e=t.unknownEnd,u<f&&(u=f),e>f+o*n.config.yearsPerInterval&&(e=f+o*n.config.yearsPerInterval),u>=f&&u<h&&u<e&&(s=(e-u)*n.pixelsPerYear)),s}var r,f,u,l;for(n.isBusy=!0,n.timelines=[],n.config={intervalWidth:360,yearsPerInterval:500,startYear:-4030,endYear:2020},n.currentYear=n.config.startYear,n.intervalYears=[1,5,10,50,100,500,1e3],n.years=[],r=0;r<n.config.endYear-n.currentYear+1;r++)f=n.currentYear+r,u=n.currentYear+r,f!==0&&(u=f<0?u+" B.C.E":u+" C.E",l={value:f,name:u},n.years.push(l));n.selectedYear=n.years[0];n.sizes=a();n.pixelsPerYear=n.config.intervalWidth/n.config.yearsPerInterval;n.changeConfig=function(){n.currentYear=n.selectedYear.value;n.sizes=a();n.pixelsPerYear=n.config.intervalWidth/n.config.yearsPerInterval};t.get("/api/timelines").then(function(t){angular.copy(t.data,n.timelines);n.changeConfig()},function(){n.errorMessage="Failed to load data"}).finally(function(){n.isBusy=!1});n.parents=[];n.children=[];n.spouse=[];n.siblings=[];n.setHighlights=function(t){n.clearHighlights();var i=p(t);n.parents=[];n.children=[];n.spouse=[];n.siblings=[];i[0].parents&&i[0].parents.length&&n.parents.push.apply(n.parents,i[0].parents);i[0].children&&i[0].children.length&&n.children.push.apply(n.children,i[0].children);i[0].spouse&&i[0].spouse.length&&n.spouse.push.apply(n.spouse,i[0].spouse);i[0].siblings&&i[0].siblings.length&&n.siblings.push.apply(n.siblings,i[0].siblings)};n.clearHighlights=function(){n.parents=[];n.children=[];n.spouse=[]};n.isParent=function(t){return n.parents.indexOf(t)!==-1};n.isChild=function(t){return n.children.indexOf(t)!==-1};n.isSpouse=function(t){return n.spouse.indexOf(t)!==-1};n.isSibling=function(t){return n.siblings.indexOf(t)!==-1};n.fastBackward=function(t){var f=i(t),r=n.config.startYear,u=n.years.filter(function(n){return n.value===r});n.selectedYear=u[0];n.changeConfig()};n.backward=function(t){var r=i(t),u=n.currentYear-n.config.yearsPerInterval*r,f=n.years.filter(function(n){return n.value===u});n.selectedYear=f[0];n.changeConfig()};n.forward=function(t){var r=i(t),u=n.currentYear+n.config.yearsPerInterval*r,f=n.years.filter(function(n){return n.value===u});n.selectedYear=f[0];n.changeConfig()};n.fastForward=function(t){var r=i(t),u=n.config.endYear-n.config.yearsPerInterval*(r-1),f=n.years.filter(function(n){return n.value===u});n.selectedYear=f[0];n.changeConfig()};n.getTimelineWidth=function(t){var r=i(t),u=n.config.intervalWidth*r+"px";return{width:u}};n.getTimelineClass=function(n){return"visible-"+n+"-block"};n.getTimelineTitle=function(t){var i=t.name+" ["+t.meaning+"] \n";return i+n.getTimelineRangeString(t)};n.getTimelineRangeString=function(n){var i="",t=y(n);return i+=t.start<0?t.start*-1+" B.C.E":t.start===0?"?":t.start+" C.E",i+=" - ",i+(t.end<0?t.end*-1+" B.C.E":t.end===0?"?":t.end+" C.E")};n.getEventYearString=function(n){return""+(n<0?n*-1+" B.C.E":n+" C.E")};n.getEventTitle=function(t){var i=t.name+" \n";return i+n.getEventYearString(t.year)};n.getIntervalWidth=function(){var t=n.config.intervalWidth+"px";return{width:t}};n.selectTimeline=function(t){t.isSelected=!t.isSelected;n.setHighlights(t.id)};n.getHtmlEventText=function(n){var t=new showdown.Converter;return t.makeHtml(n)};n.getImageSrc=function(n){return n?n:"./images/placeholder.png"};n.$watch("sizes",function(){n.getCurrentEvents=function(n,t){return w(n,t)};n.getTimelineDetailsVoidWidth=function(n,t){var i=v(n,t)-10+"px";return{width:i}};n.getEventVoidWidth=function(n,t,i){var r=b(n,t,i)+"px";return{width:r}};n.getTimelineVoidWidth=function(n,t){var i=v(n,t)+"px";return{width:i}};n.getCompleteWidth=function(n,t){var i=d(n,t)+"px";return{width:i}};n.getUnknownStartWidth=function(n,t){var i=h(n,t)+"px";return{width:i}};n.getMainWidth=function(n,t){var i=s(n,t)+"px";return{width:i}};n.getUnknownEndWidth=function(n,t){var i=c(n,t)+"px";return{width:i}};n.getUnknownStartTimelineName=function(n,t){var i=h(n,t),r=s(n,t),u=c(n,t);return r===0&&i>0&&i>u?n.name:""};n.getMainTimelineName=function(n,t){var i=s(n,t);return i>0?n.name:""};n.getUnknownEndTimelineName=function(n,t){var r=h(n,t),u=s(n,t),i=c(n,t);return u===0&&i>0&&i>r?n.name:""}})}])})();